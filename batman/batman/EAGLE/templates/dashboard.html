
{% extends "base.html" %}

{% block content %}
<!-- AI Greeting for Admin -->
{% if session.role == 'Admin' %}
<div id="ai-greeting" class="ai-greeting" style="display: none;">
    <div class="d-flex align-items-center">
        <i class="fas fa-robot me-3 fa-2x"></i>
        <div>
            <h5 class="mb-1">ðŸ¦… Eagle AI Assistant</h5>
            <p class="mb-0" id="ai-message">Namaste Nigam Ji! I hope you are doing well. Have a great day!</p>
        </div>
    </div>
</div>
{% endif %}

<!-- Dashboard Section -->
<div id="dashboard" class="content-section">
    <div class="card">
        <div class="card-body">
            <h2 class="card-title">
                <i class="fas fa-tachometer-alt text-primary"></i> Dashboard
            </h2>
            <div class="row mt-4" id="stats-cards">
                <!-- Stats will be loaded here -->
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Task Status Distribution</h5>
                    <canvas id="statusChart" width="400" height="200" style="max-width: 400px; max-height: 200px;"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Priority Distribution</h5>
                    <canvas id="priorityChart" width="400" height="200" style="max-width: 400px; max-height: 200px;"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card mt-4">
        <div class="card-body">
            <h5 class="card-title">Recent Tasks</h5>
            <div id="recent-tasks">
                <!-- Recent tasks will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Tasks Section -->
<div id="tasks" class="content-section" style="display: none;">
    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
                <h2 class="card-title mb-0">
                    <i class="fas fa-list-check text-primary"></i> Tasks
                </h2>
                {% if session.role == 'Admin' %}
                <button class="btn btn-primary mt-2 mt-md-0" onclick="showCreateTaskModal()">
                    <i class="fas fa-plus me-1"></i> New Task
                </button>
                {% endif %}
            </div>
            <div id="tasks-list">
                <!-- Tasks will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Messages Section -->
<div id="messages" class="content-section" style="display: none;">
    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-users text-primary"></i> Users
                    </h5>
                    {% if session.role == 'Admin' %}
                    <div class="mb-3">
                        <button class="btn btn-sm btn-outline-primary" onclick="loadAllUsers()">All Companies</button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="loadCompanyUsers()">My Company</button>
                    </div>
                    {% endif %}
                    <div id="users-list" style="max-height: 400px; overflow-y: auto;">
                        <!-- Users will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-comments text-primary"></i> 
                            <span id="chat-title">Company Chat</span>
                        </h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearSelectedUser()">
                            <i class="fas fa-users"></i> Company Chat
                        </button>
                    </div>
                    
                    <div class="chat-container">
                        <div class="chat-messages" id="chat-messages">
                            <!-- Messages will be loaded here -->
                        </div>
                        <div class="chat-input p-3 bg-light rounded">
                            <div id="chat-recipient" class="mb-2" style="display: none;">
                                <small class="text-muted">Private message to: <strong id="recipient-name"></strong></small>
                            </div>
                            <div class="input-group">
                                <input type="text" class="form-control" id="message-input" 
                                       placeholder="Type your message..." maxlength="500">
                                <button class="btn btn-primary" onclick="sendMessage()">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Admin Panel -->
{% if session.role == 'Admin' %}
<div id="admin" class="content-section" style="display: none;">
    <div class="card">
        <div class="card-body">
            <h2 class="card-title">
                <i class="fas fa-cog text-primary"></i> Admin Panel
            </h2>
            
            <div class="row mt-4">
                <div class="col-md-6 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Company Management</h5>
                            <button class="btn btn-success mb-2" onclick="showCreateCompanyModal()">
                                <i class="fas fa-building me-1"></i> Register Company
                            </button>
                            <div id="companies-list">
                                <!-- Companies list will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">User Management</h5>
                            <div class="mb-3">
                                <button class="btn btn-info mb-2" onclick="showCreateUserModal()">
                                    <i class="fas fa-user-plus me-1"></i> Add User
                                </button>
                                <div class="btn-group ms-2" role="group">
                                    <button class="btn btn-sm btn-outline-primary" onclick="filterUsers('all')">All Users</button>
                                    <button class="btn btn-sm btn-outline-success" onclick="filterUsers('active')">Active</button>
                                    <button class="btn btn-sm btn-outline-warning" onclick="filterUsers('inactive')">Inactive</button>
                                </div>
                            </div>
                            <div id="all-users-list" style="max-height: 400px; overflow-y: auto;">
                                <!-- All users list will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card mt-4">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-envelope text-info"></i> All Messages (Admin View)
                        <span id="total-messages-count" class="badge bg-info ms-2">0</span>
                    </h5>
                    <div id="admin-messages" style="max-height: 400px; overflow-y: auto;">
                        <!-- Admin messages view -->
                    </div>
                </div>
            </div>
            
            <!-- Reminders Section -->
            <div class="card mt-4">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-bell text-warning"></i> Reminders Management
                    </h5>
                    <div class="row">
                        <div class="col-md-8">
                            <button class="btn btn-warning mb-3" onclick="showCreateReminderModal()">
                                <i class="fas fa-plus me-1"></i> Add Reminder
                            </button>
                            <div id="reminders-list" style="max-height: 400px; overflow-y: auto;">
                                <!-- Reminders list will be loaded here -->
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle"></i> AI Assistant Message</h6>
                                <div id="ai-reminder-message">
                                    Namaste Nigam Ji! I hope you are doing well. You have no upcoming reminders at the moment. Have a productive day!
                                </div>
                            </div>
                            <div class="alert alert-warning">
                                <h6><i class="fas fa-clock"></i> Upcoming Alerts</h6>
                                <div id="upcoming-reminders-list">
                                    <!-- Upcoming reminders -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Company & User Management Section -->
<div id="management" class="content-section" style="display: none;">
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-building text-primary"></i> Companies
                    </h5>
                    <button class="btn btn-success btn-sm mb-3" onclick="showCreateCompanyModal()">
                        <i class="fas fa-plus me-1"></i> Add Company
                    </button>
                    <div id="companies-management-list">
                        <!-- Companies list -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-users text-primary"></i> All Users
                    </h5>
                    <button class="btn btn-info btn-sm mb-3" onclick="showCreateUserModal()">
                        <i class="fas fa-user-plus me-1"></i> Add User
                    </button>
                    <div id="users-management-list" style="max-height: 500px; overflow-y: auto;">
                        <!-- Users list -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Modals -->
{% if session.role == 'Admin' %}
<!-- Create Task Modal -->
<div class="modal fade" id="createTaskModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createTaskForm" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Title *</label>
                            <input type="text" class="form-control" id="task-title" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Priority</label>
                            <select class="form-control" id="task-priority">
                                <option value="Low">Low</option>
                                <option value="Medium" selected>Medium</option>
                                <option value="High">High</option>
                                <option value="Critical">Critical</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="task-description" rows="3"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="task-start-date">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Deadline</label>
                            <input type="date" class="form-control" id="task-deadline">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Assign to *</label>
                        <select class="form-control" id="task-assignee" required>
                            <option value="">Select user...</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Attach Files (PDF, Excel, Word, Text)</label>
                        <input type="file" class="form-control" id="task-files" multiple 
                               accept=".pdf,.xlsx,.xls,.doc,.docx,.txt,.csv">
                        <small class="text-muted">Max file size: 16MB per file</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createTask()">Create Task</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Task Modal -->
<div class="modal fade" id="editTaskModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editTaskForm">
                    <input type="hidden" id="edit-task-id">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Title *</label>
                            <input type="text" class="form-control" id="edit-task-title" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Priority</label>
                            <select class="form-control" id="edit-task-priority">
                                <option value="Low">Low</option>
                                <option value="Medium">Medium</option>
                                <option value="High">High</option>
                                <option value="Critical">Critical</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="edit-task-description" rows="3"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-control" id="edit-task-status">
                                <option value="Pending">Pending</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="edit-task-start-date">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Deadline</label>
                            <input type="date" class="form-control" id="edit-task-deadline">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Assign to *</label>
                        <select class="form-control" id="edit-task-assignee" required>
                            <option value="">Select user...</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" onclick="deleteTask()" id="delete-task-btn">Delete Task</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateTask()">Update Task</button>
            </div>
        </div>
    </div>
</div>

<!-- Create Company Modal -->
<div class="modal fade" id="createCompanyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Register New Company</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createCompanyForm">
                    <div class="mb-3">
                        <label class="form-label">Company Name</label>
                        <input type="text" class="form-control" id="company-name" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="createCompany()">Register Company</button>
            </div>
        </div>
    </div>
</div>

<!-- Create User Modal -->
<div class="modal fade" id="createUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createUserForm">
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-control" id="user-username" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mobile Number</label>
                        <input type="tel" class="form-control" id="user-mobile-number" placeholder="Enter mobile number for Telegram notifications" required>
                        <small class="text-muted">This will be used for Telegram notifications</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="user-password" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Role</label>
                        <select class="form-control" id="user-role" required>
                            <option value="">Select role...</option>
                            <option value="Admin">Admin</option>
                            <option value="Manager">Manager</option>
                            <option value="Employee">Employee</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Company</label>
                        <select class="form-control" id="user-company" required>
                            <option value="">Select company...</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createUser()">Create User</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Task Comments Modal -->
<div class="modal fade" id="taskCommentsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    Task Comments & Files 
                    <span id="unread-indicator" class="badge bg-danger ms-2" style="display: none;">New</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- File Attachments Section -->
                <div class="mb-4">
                    <h6><i class="fas fa-paperclip me-2"></i>File Attachments</h6>
                    <div id="task-attachments" class="mb-2">
                        <!-- Attachments will be loaded here -->
                    </div>
                    
                    <!-- Upload file form -->
                    <div class="border rounded p-3 bg-light">
                        <div class="row align-items-end">
                            <div class="col-md-8">
                                <label class="form-label small">Upload File (PDF, Excel, Word, Text)</label>
                                <input type="file" class="form-control form-control-sm" id="task-file-upload" 
                                       accept=".pdf,.xlsx,.xls,.doc,.docx,.txt,.csv">
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-sm btn-outline-primary w-100" onclick="uploadTaskFile()">
                                    <i class="fas fa-upload me-1"></i>Upload
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <hr>

                <!-- Comments Section -->
                <div class="mb-3">
                    <h6><i class="fas fa-comments me-2"></i>Comments</h6>
                    <div id="comments-list" class="mb-3" style="max-height: 300px; overflow-y: auto;">
                        <!-- Comments will be loaded here -->
                    </div>
                    <div class="input-group">
                        <input type="text" class="form-control" id="new-comment" placeholder="Add a comment..." maxlength="500">
                        <button class="btn btn-primary" onclick="addComment()">
                            <i class="fas fa-comment"></i>
                        </button>
                    </div>
                </div>
                <input type="hidden" id="current-task-id">
            </div>
        </div>
    </div>
</div>

<!-- Create Reminder Modal -->
{% if session.role == 'Admin' %}
<div class="modal fade" id="createReminderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Reminder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createReminderForm">
                    <div class="mb-3">
                        <label class="form-label">Title *</label>
                        <input type="text" class="form-control" id="reminder-title" required maxlength="100">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="reminder-description" rows="3" maxlength="500"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reminder Date *</label>
                        <input type="date" class="form-control" id="reminder-date" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Alert Days Before</label>
                        <select class="form-control" id="reminder-alert-days">
                            <option value="1">1 day before</option>
                            <option value="2">2 days before</option>
                            <option value="3">3 days before</option>
                            <option value="7">1 week before</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="createReminder()">Create Reminder</button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    // Socket.IO connection
    const socket = io();
    
    // Global variables
    let selectedUserId = null;
    let selectedUserName = null;
    let statusChart = null;
    let priorityChart = null;

    // Text-to-Speech function
    function speakText(text) {
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.8;
            utterance.pitch = 1;
            utterance.volume = 0.8;
            speechSynthesis.speak(utterance);
        }
    }

    // Load data when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadDashboardData();
        loadTasks();
        loadMessages();
        loadUsers();
        loadCompanies();
        
        {% if session.role == 'Admin' %}
        // Show AI greeting for admin and speak it
        const aiGreeting = document.getElementById('ai-greeting');
        if (aiGreeting) {
            aiGreeting.style.display = 'block';
        }
        loadAllUsersForManagement();
        loadCompaniesForManagement();
        loadReminders();
        loadUpcomingReminders();
        loadAdminMessages();
        showAIGreeting();
        {% endif %}
        
        // Join user room for private messages
        socket.emit('join_user_room');
    });
    
    // Socket events
    socket.on('new_message', function(data) {
        if (!selectedUserId) {
            addMessageToChat(data);
        }
    });
    
    socket.on('new_private_message', function(data) {
        if (selectedUserId && data.sender_id === selectedUserId) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message other';
            messageDiv.innerHTML = `
                <div class="message-header">
                    <strong>${data.sender_name}</strong>
                    <small class="text-muted ms-2">${formatTime(data.timestamp)}</small>
                </div>
                <div class="message-body">${data.message}</div>
            `;
            
            document.getElementById('chat-messages').appendChild(messageDiv);
            document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
        }
    });
    
    socket.on('user_joined', function(data) {
        if (!selectedUserId) {
            addSystemMessage(data.message);
        }
    });
    
    socket.on('user_left', function(data) {
        if (!selectedUserId) {
            addSystemMessage(data.message);
        }
    });
    
    // Functions
    async function loadDashboardData() {
        try {
            const response = await fetch('/api/task_stats');
            const stats = await response.json();
            
            document.getElementById('stats-cards').innerHTML = `
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card bg-warning text-white stats-card">
                        <div class="card-body text-center">
                            <i class="fas fa-clock fa-2x mb-2"></i>
                            <h3>${stats.pending}</h3>
                            <p class="mb-0">Pending</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card bg-info text-white stats-card">
                        <div class="card-body text-center">
                            <i class="fas fa-spinner fa-2x mb-2"></i>
                            <h3>${stats.in_progress}</h3>
                            <p class="mb-0">In Progress</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card bg-success text-white stats-card">
                        <div class="card-body text-center">
                            <i class="fas fa-check fa-2x mb-2"></i>
                            <h3>${stats.completed}</h3>
                            <p class="mb-0">Completed</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card bg-primary text-white stats-card">
                        <div class="card-body text-center">
                            <i class="fas fa-list fa-2x mb-2"></i>
                            <h3>${stats.total}</h3>
                            <p class="mb-0">Total</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Update AI message for admin
            {% if session.role == 'Admin' %}
            const aiMessage = document.getElementById('ai-message');
            if (aiMessage) {
                const taskInfo = `Current status: ${stats.pending} pending, ${stats.in_progress} in progress, ${stats.completed} completed tasks.`;
                aiMessage.textContent = `Namaste Nigam Ji! I hope you are doing well. Have a great day! ${taskInfo}`;
                
                // Speak the greeting with task information
                const voiceMessage = `Namaste Nigam Ji! I hope you are doing well. Have a great day! You have ${stats.pending} pending tasks, ${stats.in_progress} tasks in progress, and ${stats.completed} completed tasks.`;
                speakText(voiceMessage);
            }
            {% endif %}
            
            // Create charts
            createStatusChart(stats);
            createPriorityChart(stats.by_priority);
            
            // Load recent tasks for display
            const tasksResponse = await fetch('/api/tasks');
            const tasks = await tasksResponse.json();
            const recentTasks = tasks.slice(0, 5);
            
            document.getElementById('recent-tasks').innerHTML = recentTasks.map(task => `
                <div class="task-card card mb-2 status-${task.status.toLowerCase().replace(' ', '')} priority-${(task.priority || 'medium').toLowerCase()}">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${task.title}</h6>
                                <small class="text-muted">${task.description || 'No description'}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-secondary">${task.status}</span>
                                ${task.priority ? `<br><span class="badge bg-${getPriorityColor(task.priority)} mt-1">${task.priority}</span>` : ''}
                            </div>
                        </div>
                        ${task.assigned_to ? `<small class="text-muted d-block mt-2">Assigned to: ${task.assigned_to}</small>` : ''}
                        ${task.deadline ? `<small class="text-muted d-block">Deadline: ${formatDate(task.deadline)}</small>` : ''}
                    </div>
                </div>
            `).join('');
            
        } catch (error) {
            console.error('Error loading dashboard data:', error);
        }
    }
    
    function createStatusChart(stats) {
        const ctx = document.getElementById('statusChart').getContext('2d');
        if (statusChart) statusChart.destroy();
        
        statusChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Pending', 'In Progress', 'Completed'],
                datasets: [{
                    data: [stats.pending, stats.in_progress, stats.completed],
                    backgroundColor: ['#ffc107', '#17a2b8', '#28a745'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: false,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    function createPriorityChart(priorityStats) {
        const ctx = document.getElementById('priorityChart').getContext('2d');
        if (priorityChart) priorityChart.destroy();
        
        priorityChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Critical', 'High', 'Medium', 'Low'],
                datasets: [{
                    label: 'Tasks',
                    data: [priorityStats.critical, priorityStats.high, priorityStats.medium, priorityStats.low],
                    backgroundColor: ['#dc3545', '#fd7e14', '#17a2b8', '#6c757d'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: false,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
    
    async function loadTasks() {
        try {
            const response = await fetch('/api/tasks');
            const tasks = await response.json();
            
            document.getElementById('tasks-list').innerHTML = tasks.map(task => {
                const isOverdue = task.deadline && new Date(task.deadline) < new Date() && task.status !== 'Completed';
                const deadlineStyle = isOverdue ? 'color: red; font-weight: bold;' : '';
                
                return `
                <div class="task-card card mb-3 status-${task.status.toLowerCase().replace(' ', '')} priority-${(task.priority || 'medium').toLowerCase()} ${isOverdue ? 'border-danger' : ''}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start flex-wrap">
                            <div class="flex-grow-1">
                                <h5 class="card-title">
                                    ${task.title}
                                    ${isOverdue ? '<i class="fas fa-exclamation-triangle text-danger ms-2" title="Overdue"></i>' : ''}
                                </h5>
                                <p class="card-text">${task.description || 'No description'}</p>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <small class="text-muted d-block">Created: ${formatDate(task.created_at)}</small>
                                        ${task.assigned_to_name ? `<small class="text-muted d-block">Assigned to: ${task.assigned_to_name}</small>` : ''}
                                    </div>
                                    <div class="col-md-6">
                                        ${task.start_date ? `<small class="text-muted d-block">Start: ${formatDate(task.start_date)}</small>` : ''}
                                        ${task.deadline ? `<small class="d-block" style="${deadlineStyle}">Deadline: ${formatDate(task.deadline)} ${isOverdue ? '(OVERDUE)' : ''}</small>` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-end mt-2 mt-md-0">
                                <span class="badge bg-secondary mb-2">${task.status}</span>
                                ${task.priority ? `<br><span class="badge bg-${getPriorityColor(task.priority)} mb-2">${task.priority}</span>` : ''}
                                
                                {% if session.role == 'Admin' %}
                                <br>
                                <div class="btn-group d-flex d-md-inline-flex mb-2">
                                    <button class="btn btn-sm btn-outline-primary" onclick="editTask(${task.id})" title="Edit Task">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteTask(${task.id})" title="Delete Task">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                {% else %}
                                <br>
                                <div class="btn-group d-flex d-md-inline-flex">
                                    <button class="btn btn-sm btn-outline-warning" onclick="updateTaskStatus(${task.id}, 'Pending')" ${task.status === 'Completed' ? 'disabled' : ''}>Pending</button>
                                    <button class="btn btn-sm btn-outline-info" onclick="updateTaskStatus(${task.id}, 'In Progress')" ${task.status === 'Completed' ? 'disabled' : ''}>In Progress</button>
                                    <button class="btn btn-sm btn-outline-success" onclick="updateTaskStatus(${task.id}, 'Completed')" ${task.status === 'Completed' ? 'disabled' : ''}>Completed</button>
                                </div>
                                ${task.status === 'Completed' ? '<br><small class="text-success"><i class="fas fa-check-circle"></i> Task Completed - No further actions needed</small>' : ''}
                                {% endif %}
                                
                                <br><button class="btn btn-sm btn-outline-primary mt-2" onclick="showTaskComments(${task.id})">
                                    <i class="fas fa-comments"></i> Comments & Files
                                    <span id="comment-badge-${task.id}" class="badge bg-danger ms-1" style="display: none;">New</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;}).join('');
            
        } catch (error) {
            console.error('Error loading tasks:', error);
        }
    }
    
    async function loadMessages() {
        try {
            const response = await fetch('/api/messages');
            const messages = await response.json();
            
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = '';
            
            messages.forEach(message => {
                addMessageToChat(message, false);
            });
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
        } catch (error) {
            console.error('Error loading messages:', error);
        }
    }
    
    async function loadUsers() {
        try {
            const response = await fetch('/api/users');
            const users = await response.json();
            
            const assigneeSelect = document.getElementById('task-assignee');
            if (assigneeSelect) {
                assigneeSelect.innerHTML = '<option value="">Select user...</option>' +
                    users.map(user => `<option value="${user.id}">${user.username} (${user.role})</option>`).join('');
            }
            
        } catch (error) {
            console.error('Error loading users:', error);
        }
    }
    
    async function loadCompanies() {
        try {
            const response = await fetch('/api/companies');
            const companies = await response.json();
            
            const companySelect = document.getElementById('user-company');
            if (companySelect) {
                companySelect.innerHTML = '<option value="">Select company...</option>' +
                    companies.map(company => `<option value="${company.id}">${company.name}</option>`).join('');
            }
            
            // Load companies in management section
            {% if session.role == 'Admin' %}
            const companiesList = document.getElementById('companies-list');
            if (companiesList) {
                companiesList.innerHTML = companies.map(company => `
                    <div class="border rounded p-2 mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${company.name}</strong>
                                <small class="text-muted d-block">ID: ${company.id}</small>
                            </div>
                            <i class="fas fa-building text-muted"></i>
                        </div>
                    </div>
                `).join('');
            }
            {% endif %}
            
        } catch (error) {
            console.error('Error loading companies:', error);
        }
    }
    
    function addMessageToChat(message, isNew = true) {
        const chatMessages = document.getElementById('chat-messages');
        const messageDiv = document.createElement('div');
        const isOwn = message.user_id === {{ session.user_id }};
        
        messageDiv.className = `message ${isOwn ? 'own' : 'other'}`;
        messageDiv.innerHTML = `
            <div class="message-header">
                <strong>${message.username}</strong>
                <small class="text-muted ms-2">${formatTime(message.timestamp)}</small>
            </div>
            <div class="message-body">${message.message}</div>
        `;
        
        chatMessages.appendChild(messageDiv);
        
        if (isNew) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    }
    
    function addSystemMessage(message) {
        const chatMessages = document.getElementById('chat-messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'text-center text-muted small my-2';
        messageDiv.innerHTML = `<em>${message}</em>`;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    async function loadAllUsers() {
        if ({{ session.role == 'Admin' and 'true' or 'false' }}) {
            try {
                const response = await fetch('/api/all_users');
                const users = await response.json();
                
                document.getElementById('users-list').innerHTML = users.map(user => `
                    <div class="user-item p-2 border rounded mb-2 ${user.id === selectedUserId ? 'bg-primary text-white' : 'bg-light'}" 
                         style="cursor: pointer;" onclick="selectUser(${user.id}, '${user.username}')">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${user.username}</strong>
                                <br><small class="text-muted">${user.role} - ${user.company_name}</small>
                            </div>
                            <i class="fas fa-user"></i>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading all users:', error);
            }
        }
    }
    
    async function loadCompanyUsers() {
        try {
            const response = await fetch('/api/users');
            const users = await response.json();
            
            document.getElementById('users-list').innerHTML = users.map(user => `
                <div class="user-item p-2 border rounded mb-2 ${user.id === selectedUserId ? 'bg-primary text-white' : 'bg-light'}" 
                     style="cursor: pointer;" onclick="selectUser(${user.id}, '${user.username}')">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${user.username}</strong>
                            <br><small class="text-muted">${user.role}</small>
                        </div>
                        <i class="fas fa-user"></i>
                    </div>
                </div>
            `).join('');
            
        } catch (error) {
            console.error('Error loading company users:', error);
        }
    }
    
    function selectUser(userId, username) {
        selectedUserId = userId;
        selectedUserName = username;
        
        document.getElementById('chat-title').textContent = `Private Chat with ${username}`;
        document.getElementById('chat-recipient').style.display = 'block';
        document.getElementById('recipient-name').textContent = username;
        
        // Update user list highlighting
        document.querySelectorAll('.user-item').forEach(item => {
            item.classList.remove('bg-primary', 'text-white');
            item.classList.add('bg-light');
        });
        
        event.target.closest('.user-item').classList.remove('bg-light');
        event.target.closest('.user-item').classList.add('bg-primary', 'text-white');
        
        loadPrivateMessages(userId);
    }
    
    function clearSelectedUser() {
        selectedUserId = null;
        selectedUserName = null;
        
        document.getElementById('chat-title').textContent = 'Company Chat';
        document.getElementById('chat-recipient').style.display = 'none';
        
        // Clear highlighting
        document.querySelectorAll('.user-item').forEach(item => {
            item.classList.remove('bg-primary', 'text-white');
            item.classList.add('bg-light');
        });
        
        loadMessages();
    }
    
    async function loadPrivateMessages(userId) {
        try {
            const response = await fetch(`/api/private_messages/${userId}`);
            const messages = await response.json();
            
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = '';
            
            messages.forEach(message => {
                const messageDiv = document.createElement('div');
                const isOwn = message.sender_id === {{ session.user_id }};
                
                messageDiv.className = `message ${isOwn ? 'own' : 'other'}`;
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <strong>${isOwn ? 'You' : message.sender_name}</strong>
                        <small class="text-muted ms-2">${formatTime(message.timestamp)}</small>
                    </div>
                    <div class="message-body">${message.message}</div>
                `;
                
                chatMessages.appendChild(messageDiv);
            });
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
        } catch (error) {
            console.error('Error loading private messages:', error);
        }
    }
    
    async function loadAllUsersForManagement() {
        if ({{ session.role == 'Admin' and 'true' or 'false' }}) {
            try {
                const response = await fetch('/api/all_users');
                
                if (!response.ok) {
                    throw new Error('Failed to fetch users');
                }
                
                const users = await response.json();
                console.log('Loaded users:', users); // Debug log
                
                // Update user count display
                const totalUsersCount = users.length;
                const activeUsersCount = users.filter(u => u.is_active !== false).length;
                const inactiveUsersCount = totalUsersCount - activeUsersCount;
                
                console.log(`User counts: Total=${totalUsersCount}, Active=${activeUsersCount}, Inactive=${inactiveUsersCount}`);
                
                // Update any user count displays
                const userCountElements = document.querySelectorAll('.user-count');
                userCountElements.forEach(el => el.textContent = totalUsersCount);
                
                const targetElement = document.getElementById('all-users-list');
                if (targetElement) {
                    // Add summary at the top
                    let summaryHTML = `
                        <div class="alert alert-info mb-3">
                            <h6><i class="fas fa-users"></i> User Summary</h6>
                            <div class="row text-center">
                                <div class="col-4">
                                    <strong>${totalUsersCount}</strong><br>
                                    <small>Total Users</small>
                                </div>
                                <div class="col-4">
                                    <strong style="color: green;">${activeUsersCount}</strong><br>
                                    <small>Active</small>
                                </div>
                                <div class="col-4">
                                    <strong style="color: orange;">${inactiveUsersCount}</strong><br>
                                    <small>Inactive</small>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    if (users.length === 0) {
                        targetElement.innerHTML = summaryHTML + '<div class="text-center text-muted">No users found. Create some users to get started!</div>';
                    } else {
                        targetElement.innerHTML = summaryHTML + users.map(user => {
                            const isCurrentUser = user.id === {{ session.user_id }};
                            const isActive = user.is_active !== false;
                            
                            return `
                            <div class="border rounded p-2 mb-2 user-item ${isActive ? '' : 'bg-light'}" data-status="${isActive ? 'active' : 'inactive'}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center">
                                            <strong>${user.username}</strong>
                                            ${!isActive ? '<span class="badge bg-secondary ms-2">Inactive</span>' : ''}
                                            ${isCurrentUser ? '<span class="badge bg-primary ms-2">You</span>' : ''}
                                        </div>
                                        <div class="mt-1">
                                            <span class="badge bg-${getRoleBadgeColor(user.role)}">${user.role}</span>
                                            <small class="text-muted ms-2">${user.company_name}</small>
                                            ${user.mobile_number ? `<br><small class="text-muted"><i class="fas fa-phone"></i> ${user.mobile_number}</small>` : ''}
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        ${!isCurrentUser ? `
                                            <div class="btn-group-vertical">
                                                ${isActive ? `
                                                    <button class="btn btn-sm btn-outline-warning mb-1" onclick="deactivateUser(${user.id}, '${user.username}')" title="Deactivate User">
                                                        <i class="fas fa-user-slash"></i>
                                                    </button>
                                                ` : `
                                                    <button class="btn btn-sm btn-outline-success mb-1" onclick="reactivateUser(${user.id}, '${user.username}')" title="Reactivate User">
                                                        <i class="fas fa-user-check"></i>
                                                    </button>
                                                `}
                                                <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${user.id}, '${user.username}')" title="Delete User">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        ` : '<i class="fas fa-user text-muted"></i>'}
                                    </div>
                                </div>
                            </div>
                        `;}).join('');
                    }
                }
                
                // Also load admin messages
                loadAdminMessages();
                
            } catch (error) {
                console.error('Error loading users for management:', error);
                const targetElement = document.getElementById('all-users-list');
                if (targetElement) {
                    targetElement.innerHTML = '<div class="alert alert-danger">Error loading users. Please refresh the page.</div>';
                }
            }
        }
    }

    async function loadAdminMessages() {
        if ({{ session.role == 'Admin' and 'true' or 'false' }}) {
            try {
                const response = await fetch('/api/admin/all_messages');
                
                if (!response.ok) {
                    throw new Error('Failed to fetch messages');
                }
                
                const messages = await response.json();
                console.log('Loaded admin messages:', messages); // Debug log
                
                // Update message count
                const messageCountElement = document.getElementById('total-messages-count');
                if (messageCountElement) {
                    messageCountElement.textContent = messages.length;
                }
                
                const adminMessagesElement = document.getElementById('admin-messages');
                if (adminMessagesElement) {
                    if (messages.length > 0) {
                        adminMessagesElement.innerHTML = messages.map(message => `
                            <div class="message-item border-bottom pb-2 mb-2">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div class="message-header mb-1">
                                            <strong>${message.username}</strong>
                                            <span class="badge bg-secondary ms-2">${message.company_name}</span>
                                            ${message.receiver_username ? `<span class="text-muted ms-2">â†’ ${message.receiver_username}</span>` : ''}
                                        </div>
                                        <div class="message-body">${message.message}</div>
                                    </div>
                                    <div class="text-end">
                                        <small class="text-muted">${formatTime(message.timestamp)}</small>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        adminMessagesElement.innerHTML = '<div class="text-muted text-center p-3">No messages found. Users will appear here once they start messaging.</div>';
                    }
                }
                
            } catch (error) {
                console.error('Error loading admin messages:', error);
                const adminMessagesElement = document.getElementById('admin-messages');
                if (adminMessagesElement) {
                    adminMessagesElement.innerHTML = '<div class="alert alert-danger">Error loading messages. Please refresh the page.</div>';
                }
            }
        }
    }

    function filterUsers(status) {
        const userItems = document.querySelectorAll('.user-item');
        userItems.forEach(item => {
            const itemStatus = item.getAttribute('data-status');
            if (status === 'all' || itemStatus === status) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });

        // Update button states
        document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
    }

    async function deactivateUser(userId, username) {
        if (!confirm(`Are you sure you want to deactivate user "${username}"? They will not be able to log in.`)) {
            return;
        }

        try {
            const response = await fetch(`/api/admin/deactivate_user/${userId}`, {
                method: 'POST'
            });

            const data = await response.json();

            if (data.success) {
                loadAllUsersForManagement();
                alert(`User "${username}" has been deactivated successfully.`);
            } else {
                alert('Failed to deactivate user: ' + data.message);
            }

        } catch (error) {
            console.error('Error deactivating user:', error);
            alert('Error deactivating user');
        }
    }

    async function reactivateUser(userId, username) {
        if (!confirm(`Are you sure you want to reactivate user "${username}"?`)) {
            return;
        }

        try {
            const response = await fetch(`/api/admin/reactivate_user/${userId}`, {
                method: 'POST'
            });

            const data = await response.json();

            if (data.success) {
                loadAllUsersForManagement();
                alert(`User "${username}" has been reactivated successfully.`);
            } else {
                alert('Failed to reactivate user: ' + data.message);
            }

        } catch (error) {
            console.error('Error reactivating user:', error);
            alert('Error reactivating user');
        }
    }

    async function deleteUser(userId, username) {
        if (!confirm(`Are you sure you want to PERMANENTLY DELETE user "${username}"? This action cannot be undone!\n\nNote: Users with assigned tasks cannot be deleted and should be deactivated instead.`)) {
            return;
        }

        try {
            const response = await fetch(`/api/admin/delete_user/${userId}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (data.success) {
                loadAllUsersForManagement();
                alert(`User "${username}" has been deleted successfully.`);
            } else {
                alert('Failed to delete user: ' + data.message);
            }

        } catch (error) {
            console.error('Error deleting user:', error);
            alert('Error deleting user');
        }
    }
    
    async function loadCompaniesForManagement() {
        if ({{ session.role == 'Admin' and 'true' or 'false' }}) {
            try {
                const response = await fetch('/api/companies');
                const companies = await response.json();
                
                const managementList = document.getElementById('companies-management-list');
                if (managementList) {
                    managementList.innerHTML = companies.map(company => `
                        <div class="border rounded p-2 mb-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${company.name}</strong>
                                    <small class="text-muted d-block">ID: ${company.id}</small>
                                </div>
                                <i class="fas fa-building text-muted"></i>
                            </div>
                        </div>
                    `).join('');
                }
                
            } catch (error) {
                console.error('Error loading companies:', error);
            }
        }
    }
    
    async function sendMessage() {
        const input = document.getElementById('message-input');
        const message = input.value.trim();
        
        if (!message) return;
        
        try {
            const body = { message };
            if (selectedUserId) {
                body.receiver_id = selectedUserId;
            }
            
            const response = await fetch('/api/send_message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(body)
            });
            
            if (response.ok) {
                input.value = '';
                
                // Reload messages
                if (selectedUserId) {
                    loadPrivateMessages(selectedUserId);
                } else {
                    loadMessages();
                }
            }
            
        } catch (error) {
            console.error('Error sending message:', error);
        }
    }
    
    // Enter key to send message
    document.getElementById('message-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
    
    {% if session.role == 'Admin' %}
    function showCreateTaskModal() {
        new bootstrap.Modal(document.getElementById('createTaskModal')).show();
    }
    
    function showCreateCompanyModal() {
        new bootstrap.Modal(document.getElementById('createCompanyModal')).show();
    }
    
    function showCreateUserModal() {
        new bootstrap.Modal(document.getElementById('createUserModal')).show();
    }
    
    async function createTask() {
        const title = document.getElementById('task-title').value;
        const description = document.getElementById('task-description').value;
        const assigned_to = document.getElementById('task-assignee').value;
        const start_date = document.getElementById('task-start-date').value;
        const deadline = document.getElementById('task-deadline').value;
        const priority = document.getElementById('task-priority').value;
        
        if (!title || !assigned_to) {
            alert('Please fill in all required fields');
            return;
        }
        
        try {
            const response = await fetch('/api/create_task', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ title, description, assigned_to, start_date, deadline, priority })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Upload files if any
                const fileInput = document.getElementById('task-files');
                if (fileInput.files.length > 0) {
                    // Get the task ID from a subsequent call or implement file upload after task creation
                    // For now, we'll handle this in the task comments section
                }
                
                bootstrap.Modal.getInstance(document.getElementById('createTaskModal')).hide();
                loadTasks();
                loadDashboardData();
                document.getElementById('createTaskForm').reset();
            } else {
                alert('Failed to create task: ' + data.message);
            }
            
        } catch (error) {
            console.error('Error creating task:', error);
            alert('Error creating task');
        }
    }

    async function editTask(taskId) {
        try {
            // Get task details
            const response = await fetch('/api/tasks');
            const tasks = await response.json();
            const task = tasks.find(t => t.id === taskId);
            
            if (!task) {
                alert('Task not found');
                return;
            }
            
            // Populate edit form
            document.getElementById('edit-task-id').value = task.id;
            document.getElementById('edit-task-title').value = task.title;
            document.getElementById('edit-task-description').value = task.description || '';
            document.getElementById('edit-task-status').value = task.status;
            document.getElementById('edit-task-start-date').value = task.start_date || '';
            document.getElementById('edit-task-deadline').value = task.deadline || '';
            document.getElementById('edit-task-priority').value = task.priority || 'Medium';
            document.getElementById('edit-task-assignee').value = task.assigned_to;
            
            // Load users for assignee dropdown
            await loadUsers();
            
            new bootstrap.Modal(document.getElementById('editTaskModal')).show();
            
        } catch (error) {
            console.error('Error loading task for edit:', error);
            alert('Error loading task details');
        }
    }

    async function updateTask() {
        const taskId = document.getElementById('edit-task-id').value;
        const title = document.getElementById('edit-task-title').value;
        const description = document.getElementById('edit-task-description').value;
        const status = document.getElementById('edit-task-status').value;
        const assigned_to = document.getElementById('edit-task-assignee').value;
        const start_date = document.getElementById('edit-task-start-date').value;
        const deadline = document.getElementById('edit-task-deadline').value;
        const priority = document.getElementById('edit-task-priority').value;
        
        if (!title || !assigned_to) {
            alert('Please fill in all required fields');
            return;
        }
        
        try {
            const response = await fetch(`/api/admin/update_task/${taskId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    title, description, assigned_to, start_date, deadline, priority, status 
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('editTaskModal')).hide();
                loadTasks();
                loadDashboardData();
            } else {
                alert('Failed to update task: ' + data.message);
            }
            
        } catch (error) {
            console.error('Error updating task:', error);
            alert('Error updating task');
        }
    }

    async function confirmDeleteTask(taskId) {
        if (confirm('Are you sure you want to delete this task? This action cannot be undone.')) {
            await deleteTaskById(taskId);
        }
    }

    async function deleteTask() {
        const taskId = document.getElementById('edit-task-id').value;
        if (confirm('Are you sure you want to delete this task? This action cannot be undone.')) {
            bootstrap.Modal.getInstance(document.getElementById('editTaskModal')).hide();
            await deleteTaskById(taskId);
        }
    }

    async function deleteTaskById(taskId) {
        try {
            const response = await fetch(`/api/admin/delete_task/${taskId}`, {
                method: 'DELETE'
            });
            
            const data = await response.json();
            
            if (data.success) {
                loadTasks();
                loadDashboardData();
                alert('Task deleted successfully');
            } else {
                alert('Failed to delete task: ' + data.message);
            }
            
        } catch (error) {
            console.error('Error deleting task:', error);
            alert('Error deleting task');
        }
    }
    
    async function createCompany() {
        const name = document.getElementById('company-name').value;
        
        if (!name) {
            alert('Please enter company name');
            return;
        }
        
        try {
            const response = await fetch('/api/register_company', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ name })
            });
            
            const data = await response.json();
            
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('createCompanyModal')).hide();
                loadCompanies();
                document.getElementById('createCompanyForm').reset();
                alert('Company registered successfully!');
            } else {
                alert('Failed to register company: ' + data.message);
            }
            
        } catch (error) {
            console.error('Error creating company:', error);
            alert('Error creating company');
        }
    }
    
    async function createUser() {
        const username = document.getElementById('user-username').value;
        const mobile_number = document.getElementById('user-mobile-number').value;
        const password = document.getElementById('user-password').value;
        const role = document.getElementById('user-role').value;
        const company_id = document.getElementById('user-company').value;
        
        if (!username || !mobile_number || !password || !role || !company_id) {
            alert('Please fill in all fields');
            return;
        }
        
        try {
            const response = await fetch('/api/create_user', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username, mobile_number, password, role, company_id: parseInt(company_id) })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('Create user response:', data); // Debug log
            
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('createUserModal')).hide();
                loadUsers();
                loadAllUsersForManagement(); // Refresh the user management list
                document.getElementById('createUserForm').reset();
                alert('User created successfully!');
            } else {
                alert('Failed to create user: ' + (data.message || 'Unknown error'));
            }
            
        } catch (error) {
            console.error('Error creating user:', error);
            alert('Error creating user: ' + error.message);
        }
    }
    {% endif %}
    
    {% if session.role != 'Admin' %}
    async function updateTaskStatus(taskId, status) {
        try {
            const response = await fetch('/api/update_task_status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ task_id: taskId, status })
            });
            
            const data = await response.json();
            
            if (data.success) {
                loadTasks();
                loadDashboardData();
            } else {
                alert('Failed to update task: ' + data.message);
            }
            
        } catch (error) {
            console.error('Error updating task:', error);
            alert('Error updating task');
        }
    }
    {% endif %}
    
    async function showTaskComments(taskId) {
        document.getElementById('current-task-id').value = taskId;
        
        try {
            // Load comments
            const commentsResponse = await fetch(`/api/task_comments/${taskId}`);
            const comments = await commentsResponse.json();
            
            const commentsList = document.getElementById('comments-list');
            commentsList.innerHTML = comments.map(comment => `
                <div class="comment border-bottom pb-2 mb-2">
                    <div class="d-flex justify-content-between">
                        <strong>${comment.username}</strong>
                        <small class="text-muted">${formatTime(comment.created_at)}</small>
                    </div>
                    <p class="mb-0 mt-1">${comment.comment}</p>
                </div>
            `).join('');
            
            // Load attachments
            const attachmentsResponse = await fetch(`/api/task_attachments/${taskId}`);
            const attachments = await attachmentsResponse.json();
            
            const attachmentsList = document.getElementById('task-attachments');
            attachmentsList.innerHTML = attachments.map(attachment => `
                <div class="d-flex justify-content-between align-items-center border rounded p-2 mb-2 bg-light">
                    <div>
                        <i class="fas fa-${getFileIcon(attachment.file_type)} me-2"></i>
                        <strong>${attachment.original_filename}</strong>
                        <small class="text-muted d-block">
                            Uploaded by ${attachment.uploaded_by} on ${formatDate(attachment.created_at)}
                            (${attachment.upload_type === 'task_assignment' ? 'Assignment' : 'Progress'})
                        </small>
                    </div>
                    <div>
                        <a href="/api/download_file/${attachment.id}" class="btn btn-sm btn-outline-primary me-1">
                            <i class="fas fa-download"></i>
                        </a>
                        {% if session.role == 'Admin' %}
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteAttachment(${attachment.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                        {% endif %}
                    </div>
                </div>
            `).join('') || '<small class="text-muted">No files attached</small>';
            
            // Hide unread indicator
            const badge = document.getElementById(`comment-badge-${taskId}`);
            if (badge) badge.style.display = 'none';
            
            new bootstrap.Modal(document.getElementById('taskCommentsModal')).show();
            
        } catch (error) {
            console.error('Error loading task details:', error);
        }
    }

    async function uploadTaskFile() {
        const taskId = document.getElementById('current-task-id').value;
        const fileInput = document.getElementById('task-file-upload');
        
        if (!fileInput.files.length) {
            alert('Please select a file to upload');
            return;
        }
        
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('upload_type', 'task_progress');
        
        try {
            const response = await fetch(`/api/upload_task_file/${taskId}`, {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                fileInput.value = '';
                showTaskComments(taskId); // Refresh the modal
                alert('File uploaded successfully!');
            } else {
                alert('Failed to upload file: ' + data.message);
            }
            
        } catch (error) {
            console.error('Error uploading file:', error);
            alert('Error uploading file');
        }
    }

    async function deleteAttachment(attachmentId) {
        if (!confirm('Are you sure you want to delete this attachment?')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/delete_attachment/${attachmentId}`, {
                method: 'DELETE'
            });
            
            const data = await response.json();
            
            if (data.success) {
                const taskId = document.getElementById('current-task-id').value;
                showTaskComments(taskId); // Refresh the modal
                alert('Attachment deleted successfully!');
            } else {
                alert('Failed to delete attachment: ' + data.message);
            }
            
        } catch (error) {
            console.error('Error deleting attachment:', error);
            alert('Error deleting attachment');
        }
    }

    function getFileIcon(fileType) {
        const iconMap = {
            'pdf': 'file-pdf',
            'xlsx': 'file-excel',
            'xls': 'file-excel',
            'doc': 'file-word',
            'docx': 'file-word',
            'txt': 'file-alt',
            'csv': 'file-csv'
        };
        return iconMap[fileType] || 'file';
    }

    // Socket event for comment notifications
    socket.on('new_comment_notification', function(data) {
        const badge = document.getElementById(`comment-badge-${data.task_id}`);
        if (badge) {
            badge.style.display = 'inline-block';
        }
        
        // Show toast notification
        if (Notification.permission === 'granted') {
            new Notification('New Task Comment', {
                body: data.message,
                icon: '/static/icon.png'
            });
        }
    });

    // Request notification permission
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
    
    async function addComment() {
        const taskId = document.getElementById('current-task-id').value;
        const comment = document.getElementById('new-comment').value.trim();
        
        if (!comment) return;
        
        try {
            const response = await fetch('/api/add_task_comment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ task_id: taskId, comment })
            });
            
            const data = await response.json();
            
            if (data.success) {
                document.getElementById('new-comment').value = '';
                showTaskComments(taskId); // Reload comments
            } else {
                alert('Failed to add comment');
            }
            
        } catch (error) {
            console.error('Error adding comment:', error);
        }
    }
    
    {% if session.role == 'Admin' %}
    // Reminders Functions
    async function loadReminders() {
        try {
            const response = await fetch('/api/reminders');
            const reminders = await response.json();
            
            document.getElementById('reminders-list').innerHTML = reminders.map(reminder => `
                <div class="card mb-2">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="card-title mb-1">${reminder.title}</h6>
                                <p class="card-text small mb-1">${reminder.description || 'No description'}</p>
                                <small class="text-muted">
                                    <i class="fas fa-calendar"></i> ${formatDate(reminder.reminder_date)}
                                    <span class="ms-2"><i class="fas fa-bell"></i> ${reminder.alert_days_before} days before</span>
                                </small>
                            </div>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteReminder(${reminder.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
        } catch (error) {
            console.error('Error loading reminders:', error);
        }
    }

    async function loadUpcomingReminders() {
        try {
            const response = await fetch('/api/upcoming_reminders');
            const reminders = await response.json();
            
            if (reminders.length === 0) {
                document.getElementById('upcoming-reminders-list').innerHTML = '<small class="text-muted">No upcoming reminders</small>';
                document.getElementById('ai-reminder-message').innerHTML = 'Namaste Nigam Ji! I hope you are doing well. You have no upcoming reminders at the moment. Have a productive day!';
            } else {
                document.getElementById('upcoming-reminders-list').innerHTML = reminders.map(reminder => `
                    <div class="small mb-2 p-2 bg-light rounded">
                        <strong>${reminder.title}</strong><br>
                        <small class="text-muted"><i class="fas fa-calendar"></i> ${formatDate(reminder.reminder_date)}</small>
                    </div>
                `).join('');
                
                const reminderMessage = `Namaste Nigam Ji! I hope you are doing well. You have ${reminders.length} upcoming reminder(s): ${reminders.map(r => r.title).join(', ')}. Please check your reminders section for more details.`;
                document.getElementById('ai-reminder-message').innerHTML = reminderMessage;
            }
            
        } catch (error) {
            console.error('Error loading upcoming reminders:', error);
        }
    }

    function showCreateReminderModal() {
        // Set minimum date to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('reminder-date').min = today;
        
        new bootstrap.Modal(document.getElementById('createReminderModal')).show();
    }

    async function createReminder() {
        const title = document.getElementById('reminder-title').value;
        const description = document.getElementById('reminder-description').value;
        const reminderDate = document.getElementById('reminder-date').value;
        const alertDaysBefore = document.getElementById('reminder-alert-days').value;

        if (!title || !reminderDate) {
            alert('Please fill in all required fields');
            return;
        }

        try {
            const response = await fetch('/api/create_reminder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title,
                    description,
                    reminder_date: reminderDate,
                    alert_days_before: parseInt(alertDaysBefore)
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('createReminderModal')).hide();
                loadReminders();
                loadUpcomingReminders();
                document.getElementById('createReminderForm').reset();
                alert('Reminder created successfully!');
            } else {
                alert('Failed to create reminder: ' + data.message);
            }
            
        } catch (error) {
            console.error('Error creating reminder:', error);
            alert('Error creating reminder');
        }
    }

    async function deleteReminder(reminderId) {
        if (!confirm('Are you sure you want to delete this reminder?')) {
            return;
        }

        try {
            const response = await fetch(`/api/delete_reminder/${reminderId}`, {
                method: 'DELETE'
            });
            
            const data = await response.json();
            
            if (data.success) {
                loadReminders();
                loadUpcomingReminders();
                alert('Reminder deleted successfully!');
            } else {
                alert('Failed to delete reminder: ' + data.message);
            }
            
        } catch (error) {
            console.error('Error deleting reminder:', error);
            alert('Error deleting reminder');
        }
    }

    async function showAIGreeting() {
        try {
            const response = await fetch('/api/upcoming_reminders');
            const upcomingReminders = await response.json();
            
            let greetingMessage = 'Namaste Nigam Ji! I hope you are doing well. ';
            
            if (upcomingReminders.length > 0) {
                greetingMessage += `I wanted to remind you that you have ${upcomingReminders.length} upcoming reminder(s): `;
                greetingMessage += upcomingReminders.map(r => r.title).join(', ');
                greetingMessage += '. Please check your reminders section for more details.';
            } else {
                greetingMessage += 'You have no upcoming reminders at the moment. Have a productive day!';
            }
            
            // Update AI greeting section
            const aiGreetingElement = document.getElementById('ai-greeting');
            if (aiGreetingElement) {
                aiGreetingElement.innerHTML = `
                    <div class="alert alert-info">
                        <h6><i class="fas fa-robot"></i> AI Assistant</h6>
                        <p class="mb-0">${greetingMessage}</p>
                    </div>
                `;
            }
            
        } catch (error) {
            console.error('Error showing AI greeting:', error);
        }
    }
    {% endif %}

    // Utility functions
    function formatDate(dateString) {
        if (!dateString) return '';
        return new Date(dateString).toLocaleDateString();
    }
    
    function formatTime(timeString) {
        if (!timeString) return '';
        return new Date(timeString).toLocaleTimeString();
    }
    
    function getPriorityColor(priority) {
        switch(priority) {
            case 'Critical': return 'danger';
            case 'High': return 'warning';
            case 'Medium': return 'info';
            case 'Low': return 'secondary';
            default: return 'secondary';
        }
    }
    
    function getRoleBadgeColor(role) {
        switch(role) {
            case 'Admin': return 'danger';
            case 'Manager': return 'warning';
            case 'Employee': return 'info';
            default: return 'secondary';
        }
    }
    
    // Override showSection to handle management section
    function showSection(sectionName) {
        // Hide all sections
        document.querySelectorAll('.content-section').forEach(section => {
            section.style.display = 'none';
        });
        
        // Show selected section
        document.getElementById(sectionName).style.display = 'block';
        
        // Update active nav item
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
        });
        
        // Find and activate the clicked nav item
        const activeLink = document.querySelector(`[onclick="showSection('${sectionName}')"]`);
        if (activeLink) {
            activeLink.classList.add('active');
        }
        
        // Load section-specific data
        if (sectionName === 'management' && {{ session.role == 'Admin' and 'true' or 'false' }}) {
            loadAllUsersForManagement();
            loadCompaniesForManagement();
        } else if (sectionName === 'messages') {
            loadCompanyUsers();
        }
    }
</script>
{% endblock %}
